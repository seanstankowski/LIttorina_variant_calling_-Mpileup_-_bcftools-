## copies all vcfs in from n subdirectories into a single new directory
find . -name '*.combined.vcf.gz' -exec mv {} /fastdata/bo1srs/Take_4_VCFs \;


## combine the VCFs from all batches of contigs called separately 
/data/bo1srs/bcftools_dir/bcftools/bcftools concat --file-list /fastdata/bo1srs/Take_4_VCFs/vcf_list.txt --output /fastdata/bo1srs/Take_4_VCFs/concat_108.vcf.gz --output-type z 


#hard filtering in BCFtools
/data/bo1srs/bcftools_dir/bcftools/bcftools filter -e 'FS>60.0 || SOR>3 || MQ<40 || MQRankSum<-12.5 || QD<2.0 || ReadPosRankSum<-8.0' -O z -o /fastdata/bo1srs/Take_4_VCFs/HardFilter_concat_108.vcf.gz --threads 16 /fastdata/bo1srs/Take_4_VCFs/concat_108.vcf.gz


#----- remove SNPs within 5 bp of an indel/complex polymorphism; these tend to be problematic caused by realignment problems
/data/bo1srs/bcftools-1.15/bcftools filter -g 5:indel,other /fastdata/bo1srs/Take_4_VCFs/HardFilter_concat_108.vcf.gz -o /fastdata/bo1srs/Take_4_VCFs/SNPgap5_HardFilter_concat_108.vcf.gz --output-type z --threads 16


#----- remove indels and mult-allelic snps
/data/bo1srs/bcftools-1.15/bcftools --exclude-types indels,other --max-alleles 2 --output-type z -o /fastdata/bo1srs/Take_4_VCFs/ExcludeIndelsOtherMulti_SNPgap5_HardFilters_concat_108.vcf.gz /fastdata/bo1srs/Take_4_VCFs/SNPgap5_HardFilter_concat_108.vcf.gz


#----- drop sites where average read depth is high 
/data/bo1srs/bcftools-1.15/bcftools  filter -e 'INFO/DP>4320' --output-type z --threads 16 -o /fastdata/bo1srs/Take_4_VCFs/MaxDP_ExcludeIndelsOtherMulti_SNPgap5_HardFilters_concat_108.vcf.gz /fastdata/bo1srs/Take_4_VCFs/ExcludeIndelsOtherMulti_SNPgap5_HardFilters_concat_108.vcf.gz 


#----- soft filter individual genotypes for depth and quality 
/data/bo1srs/bcftools-1.15/bcftools filter -S . -e 'FMT/DP<5 | FMT/GQ<20' -O z -o /fastdata/bo1srs/Take_4_VCFs/Softfilters_MaxDP_ExcludeIndelsOtherMulti_SNPgap5_HardFilters_concat_108.vcf.gz /fastdata/bo1srs/Take_4_VCFs/MaxDP_ExcludeIndelsOtherMulti_SNPgap5_HardFilters_concat_108.vcf.gz --threads 16


#----- drop sites with > 20% missing data 
/data/bo1srs/bcftools-1.15/bcftools filter -e 'F_MISSING > 0.2' -O z -o MaxMiss0.2_Softfilters_MaxDP_ExcludeIndelsOtherMulti_SNPgap5_HardFilters_concat_108.vcf.gz Softfilters_MaxDP_ExcludeIndelsOtherMulti_SNPgap5_HardFilters_concat_108.vcf.gz


#----- drop invariant sites for a file containing only the variants as there is no point feeding the invariant sites to many analyses

/data/bo1srs/bcftools-1.15/bcftools view --min-alleles 2 /fastdata/bo1srs/all_sites_108_littorina.vcf.gz -O z -o /fastdata/bo1srs/variant_sites_108_littorina.vcf.gz --threads 16 

#----- Phase data using beagle, full dataset and variants only dataset

module load apps/java

java -jar /data/bo1srs/beagle.18May20.d20.jar gt=variants_only_108_littorina.vcf.gz  out=PHASED_variants_only_108_littorina.vcf.gz nthreads=16 

java -jar /data/bo1srs/beagle.18May20.d20.jar gt=all_sites_108_littorina.vcf.gz  out=PHASED_all_sites_108_littorina.vcf.gz nthreads=16 
